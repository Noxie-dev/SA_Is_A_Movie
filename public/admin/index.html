<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>SA IS A MOVIE - Content Management</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .cms-header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      text-align: center;
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .cms-header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
    }
    
    .cms-header p {
      margin: 10px 0 0 0;
      opacity: 0.9;
    }
    
    #nc-root {
      background: white;
      border-radius: 12px 12px 0 0;
      margin: 0 20px;
      box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
      min-height: calc(100vh - 120px);
    }
  </style>
</head>
<body>
  <div class="cms-header">
    <h1>üé¨ SA IS A MOVIE</h1>
    <p>Content Management System - Manage your trending stories, blog posts, and more</p>
  </div>
  
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script>
    // Try to load Decap CMS with fallback
    function loadDecapCMS() {
      const script = document.createElement('script');
      script.src = 'https://unpkg.com/decap-cms@^2.15.1/dist/decap-cms.js';
      script.onload = function() {
        console.log('Decap CMS loaded successfully from CDN');
      };
      script.onerror = function() {
        console.warn('Failed to load Decap CMS from CDN, trying alternative CDN...');
        // Try alternative CDN
        const altScript = document.createElement('script');
        altScript.src = 'https://cdn.jsdelivr.net/npm/decap-cms@2.15.1/dist/decap-cms.js';
        altScript.onload = function() {
          console.log('Decap CMS loaded successfully from alternative CDN');
        };
        altScript.onerror = function() {
          console.error('Failed to load Decap CMS from all CDNs. CMS functionality will be limited.');
          // Create fallback interface immediately when all CDNs fail
          setTimeout(createFallbackCMS, 1000);
        };
        document.head.appendChild(altScript);
      };
      document.head.appendChild(script);
    }
    
    // Load CMS when page is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadDecapCMS);
    } else {
      loadDecapCMS();
    }
  </script>
  
  <!-- Load simple publish button first (doesn't depend on CMS) -->
  <script src="./simple-publish.js"></script>
  
  <!-- Load custom widgets after CMS is available -->
  <script>
    // Wait for CMS to be available before loading custom widgets
    let retryCount = 0;
    const maxRetries = 50; // 5 seconds max wait time
    
    function loadCustomWidgets() {
      if (window.CMS) {
        console.log('CMS is available, loading custom widgets...');
        // Load custom widgets dynamically
        const script1 = document.createElement('script');
        script1.src = './custom-widgets.js';
        document.head.appendChild(script1);
        
        const script2 = document.createElement('script');
        script2.src = './publish-widget.js';
        document.head.appendChild(script2);
      } else if (retryCount < maxRetries) {
        retryCount++;
        console.log(`CMS not yet available, retrying... (${retryCount}/${maxRetries})`);
        setTimeout(loadCustomWidgets, 100);
      } else {
        console.warn('CMS failed to load after maximum retries. Loading widgets anyway...');
        // Load widgets even if CMS isn't available
        const script1 = document.createElement('script');
        script1.src = './custom-widgets.js';
        document.head.appendChild(script1);
        
        const script2 = document.createElement('script');
        script2.src = './publish-widget.js';
        document.head.appendChild(script2);
      }
    }
    
    // Start loading custom widgets
    loadCustomWidgets();
  </script>
  
  <script>
    // DOM manipulation polyfill to prevent removeChild errors
    (function() {
      const originalRemoveChild = Element.prototype.removeChild;
      Element.prototype.removeChild = function(child) {
        if (child && child.parentNode === this) {
          return originalRemoveChild.call(this, child);
        }
        // Silently ignore missing nodes to prevent crashes
        console.warn('Attempted to remove non-existent child node');
        return child;
      };
      
      // Also patch appendChild to be more robust
      const originalAppendChild = Element.prototype.appendChild;
      Element.prototype.appendChild = function(child) {
        if (child && child.nodeType) {
          return originalAppendChild.call(this, child);
        }
        console.warn('Attempted to append invalid child node');
        return child;
      };
    })();

    // Initialize CMS with custom configuration
    let cmsRetryCount = 0;
    const cmsMaxRetries = 50; // 5 seconds max wait time
    
    function initializeCMS() {
      if (window.CMS) {
        console.log('Initializing CMS...');
        try {
          CMS.init({
            config: {
              load_config_file: true,
              display_url: window.location.origin,
              site_url: window.location.origin,
            }
          });
          console.log('CMS initialized successfully');
        } catch (error) {
          console.error('CMS initialization failed:', error);
        }
      } else if (cmsRetryCount < cmsMaxRetries) {
        cmsRetryCount++;
        console.log(`CMS not available yet, retrying... (${cmsRetryCount}/${cmsMaxRetries})`);
        setTimeout(initializeCMS, 100);
      } else {
        console.warn('CMS failed to load after maximum retries. Skipping CMS initialization.');
      }
    }
    
    // Start CMS initialization
    initializeCMS();
    
    // Add event listeners after CMS is initialized
    let eventRetryCount = 0;
    const eventMaxRetries = 50; // 5 seconds max wait time
    
    function addEventListeners() {
      if (window.CMS) {
        console.log('Adding CMS event listeners...');
        try {
          CMS.registerEventListener({
            name: 'preSave',
            handler: ({ entry, authorLogin, commitMessage }) => {
              console.log('Pre-save event:', entry);
              return true;
            }
          });
          console.log('CMS event listeners added');
        } catch (error) {
          console.error('Failed to add CMS event listeners:', error);
        }
      } else if (eventRetryCount < eventMaxRetries) {
        eventRetryCount++;
        console.log(`CMS not available for event listeners, retrying... (${eventRetryCount}/${eventMaxRetries})`);
        setTimeout(addEventListeners, 100);
      } else {
        console.warn('CMS not available for event listeners after maximum retries. Skipping event listeners.');
      }
    }
    
    // Start adding event listeners
    addEventListeners();
    
    // Add fallback CMS interface if Decap CMS fails to load
    function createFallbackCMS() {
      const cmsContent = document.querySelector('#nc-root');
      if (cmsContent && !window.CMS) {
        console.log('Creating fallback CMS interface...');
        cmsContent.innerHTML = `
          <div style="padding: 40px; text-align: center; background: white; border-radius: 12px; margin: 20px;">
            <h2 style="color: #333; margin-bottom: 20px;">üé¨ SA IS A MOVIE - Content Management</h2>
            <p style="color: #666; margin-bottom: 30px;">The CMS is currently unavailable, but you can still manage your content using the tools below:</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 30px 0;">
              <div style="border: 2px solid #FFA500; border-radius: 8px; padding: 20px; background: #fff8f0;">
                <h3 style="color: #FFA500; margin-bottom: 15px;">üìù Create New Story</h3>
                <p style="color: #666; margin-bottom: 15px;">Use the floating publish button to create and publish stories directly to your blog.</p>
                <button onclick="alert('Use the floating üöÄ PUBLISH TO BLOG button in the top-right corner!')" 
                        style="background: #FFA500; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                  How to Publish
                </button>
              </div>
              
              <div style="border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; background: #f0f8ff;">
                <h3 style="color: #3b82f6; margin-bottom: 15px;">üìÅ Manage Content</h3>
                <p style="color: #666; margin-bottom: 15px;">Access your content files directly in your repository.</p>
                <a href="https://github.com/Noxie-dev/SA_Is_A_Movie/tree/main/src/content" 
                   target="_blank" 
                   style="background: #3b82f6; color: white; text-decoration: none; padding: 10px 20px; border-radius: 5px; display: inline-block;">
                  View Content Files
                </a>
              </div>
              
              <div style="border: 2px solid #10b981; border-radius: 8px; padding: 20px; background: #f0fdf4;">
                <h3 style="color: #10b981; margin-bottom: 15px;">üîß Troubleshooting</h3>
                <p style="color: #666; margin-bottom: 15px;">If the CMS isn't loading, try refreshing the page or check your internet connection.</p>
                <button onclick="window.location.reload()" 
                        style="background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                  Refresh Page
                </button>
              </div>
            </div>
            
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
              <h4 style="color: #333; margin-bottom: 10px;">üí° Quick Tips:</h4>
              <ul style="color: #666; text-align: left; max-width: 600px; margin: 0 auto;">
                <li>The üöÄ PUBLISH TO BLOG button works independently of the CMS</li>
                <li>You can edit content files directly in your GitHub repository</li>
                <li>All your content is safely stored in the <code>src/content/</code> folder</li>
                <li>Changes are automatically deployed when you push to GitHub</li>
              </ul>
            </div>
          </div>
        `;
      }
    }
    
    // Check for fallback CMS after timeout
    setTimeout(createFallbackCMS, 6000); // 6 seconds after page load
    
    // Also check immediately if CMS failed to load
    setTimeout(() => {
      if (!window.CMS) {
        console.log('CMS still not available, creating fallback interface...');
        createFallbackCMS();
      }
    }, 7000); // 7 seconds as backup

    // Add custom event listeners for enhanced functionality
    document.addEventListener('DOMContentLoaded', function() {
      console.log('SA IS A MOVIE CMS initialized with custom widgets');
      
      // Add copyright check functionality
      window.checkCopyright = function(imageUrl) {
        if (!imageUrl) {
          alert('Please provide an image URL to check');
          return;
        }
        
        // Show loading state
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Checking...';
        button.disabled = true;
        
        // Call the copyright check API
        fetch('/.netlify/functions/vision-copyright-check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ imageUrl })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const analysis = data.analysis;
            alert(`Copyright Check Results:\n\nStatus: ${analysis.status}\nRisk Level: ${analysis.copyrightRisk}\nConfidence: ${Math.round(analysis.confidence * 100)}%\n\nIssues: ${analysis.issues.join(', ') || 'None'}\n\nRecommendations: ${analysis.recommendations.join(', ') || 'None'}`);
          } else {
            alert('Copyright check failed: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Copyright check error:', error);
          alert('Copyright check failed: ' + error.message);
        })
        .finally(() => {
          button.textContent = originalText;
          button.disabled = false;
        });
      };
      
      // Add post story functionality
      window.postStoryToBlog = function(storyId, authorDetails) {
        if (!storyId) {
          alert('Please provide a story ID');
          return;
        }
        
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Posting...';
        button.disabled = true;
        
        fetch('/.netlify/functions/post-story-to-blog', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ storyId, authorDetails })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(`Story successfully posted to blog!\n\nBlog Post ID: ${data.blogPost.sys.id}`);
          } else {
            alert('Failed to post story: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Post story error:', error);
          alert('Failed to post story: ' + error.message);
        })
        .finally(() => {
          button.textContent = originalText;
          button.disabled = false;
        });
      };
      
      // Add publish button to the CMS interface
      function addPublishButton() {
        // Remove existing button if it exists
        const existingButton = document.querySelector('#saisa-publish-button');
        if (existingButton) {
          try {
            existingButton.remove();
          } catch (e) {
            console.warn('Could not remove existing publish button:', e);
          }
        }
        
        // Wait for the CMS to load
        setTimeout(() => {
          const cmsContent = document.querySelector('#nc-root');
          if (cmsContent && !document.querySelector('#saisa-publish-button')) {
            // Create publish button
            const publishButton = document.createElement('button');
            publishButton.id = 'saisa-publish-button';
            publishButton.innerHTML = 'üöÄ Publish Story to Blog';
            publishButton.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #FFA500, #FF6600);
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 25px;
              font-weight: bold;
              font-size: 14px;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
              z-index: 1000;
              transition: all 0.3s ease;
            `;
            
            publishButton.addEventListener('mouseenter', () => {
              publishButton.style.transform = 'scale(1.05)';
              publishButton.style.boxShadow = '0 6px 20px rgba(255, 165, 0, 0.4)';
            });
            
            publishButton.addEventListener('mouseleave', () => {
              publishButton.style.transform = 'scale(1)';
              publishButton.style.boxShadow = '0 4px 15px rgba(255, 165, 0, 0.3)';
            });
            
            publishButton.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              
              // Get current form data
              const form = document.querySelector('form');
              if (!form) {
                alert('Please open a story to publish');
                return;
              }
              
              const formData = new FormData(form);
              const storyData = {
                title: formData.get('title') || 'Untitled Story',
                description: formData.get('description') || '',
                body: formData.get('body') || '',
                category: formData.get('category') || 'culture',
                tags: formData.get('tags') ? formData.get('tags').split(',') : [],
                author: { name: 'SA IS A MOVIE Team' },
                featured_image: formData.get('featured_image') || '',
                color: formData.get('color') || 'saisa-text-blue'
              };
              
              // Show confirmation
              if (!confirm(`Publish "${storyData.title}" to the blog?`)) {
                return;
              }
              
              publishButton.innerHTML = '‚è≥ Publishing...';
              publishButton.disabled = true;
              
              // Call publish function
              fetch('/.netlify/functions/post-story-to-blog', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                  storyData: storyData,
                  authorDetails: storyData.author
                })
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  alert(`üéâ Story published successfully!\n\nTitle: ${storyData.title}\nBlog Post ID: ${data.blogPost?.sys?.id || data.blogPost?.slug || 'N/A'}`);
                } else {
                  alert('‚ùå Failed to publish: ' + (data.error || 'Unknown error'));
                }
              })
              .catch(error => {
                console.error('Publish error:', error);
                alert('‚ùå Failed to publish: ' + error.message);
              })
              .finally(() => {
                publishButton.innerHTML = 'üöÄ Publish Story to Blog';
                publishButton.disabled = false;
              });
            });
            
            try {
              document.body.appendChild(publishButton);
            } catch (e) {
              console.warn('Could not append publish button:', e);
            }
          }
        }, 2000);
      }
      
      // Add the publish button when the page loads
      addPublishButton();
      
      // Also add publish button when CMS is ready
      if (window.CMS) {
        // Use a valid event name - preSave is a valid CMS event
        window.CMS.registerEventListener({
          name: 'preSave',
          handler: () => {
            console.log('CMS pre-save event, ensuring publish button is available');
            addPublishButton();
          }
        });
      }
    });
  </script>
</body>
</html>
