<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="mobile-web-app-capable" content="yes" />
  <title>SA IS A MOVIE - Content Management</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .cms-header {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 20px;
      text-align: center;
      color: white;
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .cms-header h1 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
    }
    
    .cms-header p {
      margin: 10px 0 0 0;
      opacity: 0.9;
    }
    
    #nc-root {
      background: white;
      border-radius: 12px 12px 0 0;
      margin: 0 20px;
      box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
      min-height: calc(100vh - 120px);
    }
  </style>
</head>
<body>
  <div class="cms-header">
    <h1>🎬 SA IS A MOVIE</h1>
    <p>Content Management System - Manage your trending stories, blog posts, and more</p>
  </div>
  
  <!-- Include the script that builds the page and powers Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^2.15.1/dist/decap-cms.js"></script>
  
  <!-- Load custom widgets -->
  <script src="./custom-widgets.js"></script>
  <script src="./publish-widget.js"></script>
  <script src="./simple-publish.js"></script>
  
  <script>
    // DOM manipulation polyfill to prevent removeChild errors
    (function() {
      const originalRemoveChild = Element.prototype.removeChild;
      Element.prototype.removeChild = function(child) {
        if (child && child.parentNode === this) {
          return originalRemoveChild.call(this, child);
        }
        // Silently ignore missing nodes to prevent crashes
        console.warn('Attempted to remove non-existent child node');
        return child;
      };
      
      // Also patch appendChild to be more robust
      const originalAppendChild = Element.prototype.appendChild;
      Element.prototype.appendChild = function(child) {
        if (child && child.nodeType) {
          return originalAppendChild.call(this, child);
        }
        console.warn('Attempted to append invalid child node');
        return child;
      };
    })();

    // Initialize CMS with custom configuration
    CMS.init({
      config: {
        load_config_file: true,
        display_url: window.location.origin,
        site_url: window.location.origin,
      }
    });
    
    // Add publish button immediately after CMS loads
    CMS.registerEventListener({
      name: 'preSave',
      handler: ({ entry, authorLogin, commitMessage }) => {
        console.log('Pre-save event:', entry);
        return true;
      }
    });
    
    // Add custom event listeners for enhanced functionality
    document.addEventListener('DOMContentLoaded', function() {
      console.log('SA IS A MOVIE CMS initialized with custom widgets');
      
      // Add copyright check functionality
      window.checkCopyright = function(imageUrl) {
        if (!imageUrl) {
          alert('Please provide an image URL to check');
          return;
        }
        
        // Show loading state
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Checking...';
        button.disabled = true;
        
        // Call the copyright check API
        fetch('/.netlify/functions/vision-copyright-check', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ imageUrl })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            const analysis = data.analysis;
            alert(`Copyright Check Results:\n\nStatus: ${analysis.status}\nRisk Level: ${analysis.copyrightRisk}\nConfidence: ${Math.round(analysis.confidence * 100)}%\n\nIssues: ${analysis.issues.join(', ') || 'None'}\n\nRecommendations: ${analysis.recommendations.join(', ') || 'None'}`);
          } else {
            alert('Copyright check failed: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Copyright check error:', error);
          alert('Copyright check failed: ' + error.message);
        })
        .finally(() => {
          button.textContent = originalText;
          button.disabled = false;
        });
      };
      
      // Add post story functionality
      window.postStoryToBlog = function(storyId, authorDetails) {
        if (!storyId) {
          alert('Please provide a story ID');
          return;
        }
        
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Posting...';
        button.disabled = true;
        
        fetch('/.netlify/functions/post-story-to-blog', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ storyId, authorDetails })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert(`Story successfully posted to blog!\n\nBlog Post ID: ${data.blogPost.sys.id}`);
          } else {
            alert('Failed to post story: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Post story error:', error);
          alert('Failed to post story: ' + error.message);
        })
        .finally(() => {
          button.textContent = originalText;
          button.disabled = false;
        });
      };
      
      // Add publish button to the CMS interface
      function addPublishButton() {
        // Remove existing button if it exists
        const existingButton = document.querySelector('#saisa-publish-button');
        if (existingButton) {
          try {
            existingButton.remove();
          } catch (e) {
            console.warn('Could not remove existing publish button:', e);
          }
        }
        
        // Wait for the CMS to load
        setTimeout(() => {
          const cmsContent = document.querySelector('#nc-root');
          if (cmsContent && !document.querySelector('#saisa-publish-button')) {
            // Create publish button
            const publishButton = document.createElement('button');
            publishButton.id = 'saisa-publish-button';
            publishButton.innerHTML = '🚀 Publish Story to Blog';
            publishButton.style.cssText = `
              position: fixed;
              top: 20px;
              right: 20px;
              background: linear-gradient(135deg, #FFA500, #FF6600);
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 25px;
              font-weight: bold;
              font-size: 14px;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
              z-index: 1000;
              transition: all 0.3s ease;
            `;
            
            publishButton.addEventListener('mouseenter', () => {
              publishButton.style.transform = 'scale(1.05)';
              publishButton.style.boxShadow = '0 6px 20px rgba(255, 165, 0, 0.4)';
            });
            
            publishButton.addEventListener('mouseleave', () => {
              publishButton.style.transform = 'scale(1)';
              publishButton.style.boxShadow = '0 4px 15px rgba(255, 165, 0, 0.3)';
            });
            
            publishButton.addEventListener('click', (event) => {
              event.preventDefault();
              event.stopPropagation();
              
              // Get current form data
              const form = document.querySelector('form');
              if (!form) {
                alert('Please open a story to publish');
                return;
              }
              
              const formData = new FormData(form);
              const storyData = {
                title: formData.get('title') || 'Untitled Story',
                description: formData.get('description') || '',
                body: formData.get('body') || '',
                category: formData.get('category') || 'culture',
                tags: formData.get('tags') ? formData.get('tags').split(',') : [],
                author: { name: 'SA IS A MOVIE Team' },
                featured_image: formData.get('featured_image') || '',
                color: formData.get('color') || 'saisa-text-blue'
              };
              
              // Show confirmation
              if (!confirm(`Publish "${storyData.title}" to the blog?`)) {
                return;
              }
              
              publishButton.innerHTML = '⏳ Publishing...';
              publishButton.disabled = true;
              
              // Call publish function
              fetch('/.netlify/functions/post-story-to-blog', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                  storyData: storyData,
                  authorDetails: storyData.author
                })
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  alert(`🎉 Story published successfully!\n\nTitle: ${storyData.title}\nBlog Post ID: ${data.blogPost?.sys?.id || data.blogPost?.slug || 'N/A'}`);
                } else {
                  alert('❌ Failed to publish: ' + (data.error || 'Unknown error'));
                }
              })
              .catch(error => {
                console.error('Publish error:', error);
                alert('❌ Failed to publish: ' + error.message);
              })
              .finally(() => {
                publishButton.innerHTML = '🚀 Publish Story to Blog';
                publishButton.disabled = false;
              });
            });
            
            try {
              document.body.appendChild(publishButton);
            } catch (e) {
              console.warn('Could not append publish button:', e);
            }
          }
        }, 2000);
      }
      
      // Add the publish button when the page loads
      addPublishButton();
      
      // Also add publish button when CMS is ready
      if (window.CMS) {
        // Use a valid event name - preSave is a valid CMS event
        window.CMS.registerEventListener({
          name: 'preSave',
          handler: () => {
            console.log('CMS pre-save event, ensuring publish button is available');
            addPublishButton();
          }
        });
      }
    });
  </script>
</body>
</html>
